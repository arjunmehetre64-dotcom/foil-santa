<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Foil Santa Panic Mode</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      touch-action: manipulation;
    }
    canvas {
      display: block;
      cursor: pointer;
    }
  </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// Desktop detection
const isDesktop = window.matchMedia("(hover: hover)").matches;

// Assets
const santaImg = new Image();
santaImg.src = "image.png";

const bgImg = new Image();
bgImg.src = "image2.png";

const sounds = [
  new Audio("part1.wav"),
  new Audio("part2.wav"),
  new Audio("part3.wav")
];

let soundIndex = 0;

// Santa state
let revealed = false;
let x = canvas.width / 2;
let y = canvas.height / 2;
let targetX = x;
let targetY = y;
let rotation = 0;
let rolling = false;
let rollingSpeed = 0.5;
let firstAppearanceRolling = 0;

// Sound cycle
function playNextSound() {
  const s = sounds[soundIndex % sounds.length];
  s.currentTime = 0;
  s.play();
  soundIndex++;
}

// Move Santa away
function moveSantaAway(fromX, fromY) {
  let nx, ny;
  do {
    nx = Math.random() * canvas.width;
    ny = Math.random() * canvas.height;
  } while (Math.hypot(nx - fromX, ny - fromY) < 200);

  targetX = nx;
  targetY = ny;
  rolling = true;
  rotation = 0;

  playNextSound();
}

// Click logic
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;

  if (!revealed) {
    x = targetX = mx;
    y = targetY = my;
    revealed = true;
    firstAppearanceRolling = 18;
    playNextSound();
    return;
  }

  const dist = Math.hypot(mx - x, my - y);
  if (dist < 150 && !rolling) {
    moveSantaAway(mx, my);
  }
});

// Desktop hover panic
if (isDesktop) {
  canvas.addEventListener("mousemove", e => {
    if (!revealed || rolling) return;

    const rect = canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;

    const dist = Math.hypot(mx - x, my - y);
    if (dist < 140) {
      moveSantaAway(mx, my);
    }
  });
}

// Animation loop
function animate() {

  // Draw background image
  if (bgImg.complete) {
    ctx.drawImage(bgImg, 0, 0, canvas.width, canvas.height);
  }

  if (revealed) {

    if (firstAppearanceRolling > 0) {
      rotation += rollingSpeed * 5 + Math.random() * 0.6;
      firstAppearanceRolling--;
    }
    else if (rolling) {
      rotation += rollingSpeed * 2 + Math.random() * 0.3;
      x += (targetX - x) * 0.2;
      y += (targetY - y) * 0.2;

      if (Math.hypot(targetX - x, targetY - y) < 1) {
        x = targetX;
        y = targetY;
        rotation = 0;
        rolling = false;
      }
    }
    else {
      rotation = Math.sin(Date.now() * 0.01) * 0.05;
    }

    ctx.save();
    ctx.translate(x, y);
    ctx.rotate(rotation);
    ctx.drawImage(santaImg, -santaImg.width / 2, -santaImg.height / 2);
    ctx.restore();
  }

  requestAnimationFrame(animate);
}

animate();
</script>

</body>
</html>
